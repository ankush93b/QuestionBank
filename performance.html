<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Performance Overview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: #f3f6fa;
            margin: 0;
            padding: 0;
        }
        .performance-label {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
            margin-top: 0px;
            color: #2d3c61;
            min-height: 28px;
        }
        .performance-container {
            max-width: 1100px;
            margin: 20px auto 30px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 30px;
        }
        .circle-stat {
            background: #fff;
            border-radius: 50%;
            width: 155px;
            height: 155px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.10);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: box-shadow 0.2s;
        }
        .circle-stat:hover {
            box-shadow: 0 6px 24px rgba(0,0,0,0.18);
        }
        .circle-value {
            font-size: 2.1rem;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 8px;
        }
        .circle-label {
            font-size: 1.05rem;
            color: #555;
            letter-spacing: 0.03em;
            text-align: center;
            padding: 0 8px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto 40px auto;
            display: flex;
            align-items: flex-end;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .dropdown {
            position: relative;
            width: 180px;
            margin-top: 10px;
        }
        .dropdown-label {
            display: block;
            font-size: 0.99rem;
            color: #333;
            margin-bottom: 7px;
        }
        .dropdown-toggle {
            background: #fff;
            border: 1px solid #bfc9da;
            border-radius: 5px;
            padding: 12px 14px;
            cursor: pointer;
            font-size: 1rem;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            user-select: none;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #bfc9da;
            border-radius: 0 0 5px 5px;
            max-height: 165px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 6px 16px rgba(0,0,0,0.13);
        }
        .dropdown-menu div {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 1rem;
            color: #333;
        }
        .dropdown-menu div:hover {
            background: #f0f6ff;
        }
        .dropdown.disabled .dropdown-toggle {
            background: #f7f7f7;
            color: #aaa;
            cursor: not-allowed;
        }
        .dropdown.disabled .dropdown-menu {
            display: none !important;
        }
        button#showButton {
            padding: 12px 28px;
            font-size: 1rem;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.18s;
        }
        button#showButton:disabled {
            background: #bfc9da;
            cursor: not-allowed;
        }
        @media (max-width: 1100px) {
            .performance-container {
                flex-wrap: wrap;
                gap: 18px;
            }
        }
        @media (max-width: 900px) {
            .performance-container {
                flex-direction: column;
                align-items: center;
                gap: 18px;
            }
            .container {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 0.7s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        /* Past Performance Table */
        .past-performance-section {
            max-width: 1100px;
            margin: 10px auto 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.07);
            padding: 20px 20px 15px 20px;
        }
        .past-performance-title {
            font-size: 1.12rem;
            color: #2d3c61;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .past-table-wrap {
            overflow-x: auto;
        }
        .past-performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        .past-performance-table th, .past-performance-table td {
            padding: 9px 15px;
            text-align: center;
        }
        .past-performance-table th {
            background: #f6f8fa;
            color: #222;
            font-size: 0.99rem;
            border-bottom: 2px solid #e0e7ef;
        }
        .past-performance-table td {
            background: #fff;
            border-bottom: 1px solid #f1f1f3;
            font-size: 0.97rem;
        }
        .past-performance-table tr:last-child td {
            border-bottom: none;
        }
        .past-performance-empty {
            color: #888;
            font-size: 1rem;
            padding: 18px 0;
            text-align: center;
        }
        /* Home & Reload Button style */
        .home-btn-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 45px 0 35px 0;
        }
        .home-btn,
        .reload-btn {
            background: green;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.1rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(37,99,235,0.10);
            transition: background 0.18s, box-shadow 0.18s, transform 0.15s;
        }
        .reload-btn {
            background: #2563eb;
            margin-right: 0;
        }
        .home-btn:hover,
        .reload-btn:hover {
            box-shadow: 0 8px 24px rgba(37,99,235,0.17);
            transform: scale(1.07);
        }
        .home-btn svg, .reload-btn svg {
            width: 40px;
            height: 40px;
            display: block;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center; margin-top:30px; color:#222;">Performance Overview</h2>
    <div id="performanceSection">
        <div class="performance-label" id="performanceLabel"></div>
        <div class="performance-container" id="performanceCircles">
            <div class="loader"></div>
        </div>
    </div>
    <!-- Past Performance Section -->
    <div id="pastPerformanceSection" style="display:none;"></div>
    <div class="container">
        <!-- Subject Dropdown -->
        <div class="dropdown" id="subjectDropdown">
            <label class="dropdown-label">Select Subject</label>
            <div class="dropdown-toggle" onclick="toggleMenu('subject')">Select Subject</div>
            <div class="dropdown-menu" id="subjectMenu">
                <div onclick="selectOption('subject', 'Math')">Math</div>
                <div onclick="selectOption('subject', 'Science')">Science</div>
                <div onclick="selectOption('subject', 'History')">History</div>
                <div onclick="selectOption('subject', 'English')">English</div>
                <div onclick="selectOption('subject', 'Hindi')">Hindi</div>
                <div onclick="selectOption('subject', 'Punjabi')">Punjabi</div>
            </div>
        </div>
        <!-- Topic Dropdown -->
        <div class="dropdown disabled" id="topicDropdown">
            <label class="dropdown-label">Select Topic</label>
            <div class="dropdown-toggle" onclick="toggleMenu('topic')">Select Topic</div>
            <div class="dropdown-menu" id="topicMenu"></div>
        </div>
        <!-- Show Button -->
        <button id="showButton" onclick="showPerformance()" disabled>Show</button>
    </div>

    <!-- Reload & Home Buttons -->
    <div class="home-btn-wrapper">
        <button class="reload-btn" onclick="reloadPage()" title="Reload Page">
            <!-- Simple Reload SVG icon -->
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 4V1L7 6l5 5V7c3.31 0 6 2.69 6 6a6 6 0 1 1-12 0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="home-btn" onclick="goHome()" title="Go to Home">
            <!-- Simple Home SVG icon -->
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M3 10.8L12 4L21 10.8V19.2C21 19.6418 20.6418 20 20.2 20H16V14.4C16 14.1791 15.8209 14 15.6 14H8.4C8.17909 14 8 14.1791 8 14.4V20H3.8C3.35817 20 3 19.6418 3 19.2V10.8Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <script>
        // FIREBASE INIT
        const firebaseConfig = {
            apiKey: "AIzaSyBAS78y1CVF1lPppeyAojbw3k07mWW4lLk",
            authDomain: "questionbank-f047f.firebaseapp.com",
            projectId: "questionbank-f047f",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Topic map (for dropdowns)
        const topicMap = {
            Math: ["Squares upto 10", "Algebra", "Geometry", "Trigonometry", "Calculus", "Probability"],
            Science: ["Physics", "Chemistry", "Biology", "Astronomy", "Geology"],
            History: ["Ancient", "Medieval", "Modern", "World Wars"],
            English: ["Grammar", "Literature", "Writing Skills", "Comprehension"],
            Hindi: ["व्याकरण", "साहित्य", "कविता", "कहानी"],
            Punjabi: ["ਵਿਆਕਰਨ", "ਸਾਹਿਤ", "ਕਵਿਤਾ", "ਕਹਾਣੀ"]
        };

        let selectedSubject = null;
        let selectedTopic = null;

        function closeMenusExcept(type) {
            if (type !== 'subject') document.getElementById('subjectMenu').style.display = 'none';
            if (type !== 'topic') document.getElementById('topicMenu').style.display = 'none';
        }

        document.body.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                closeMenusExcept();
            }
        });

        function toggleMenu(type) {
            if (type === 'topic' && document.getElementById('topicDropdown').classList.contains('disabled')) return;
            const menu = document.getElementById(type + 'Menu');
            const isOpen = menu.style.display === 'block';
            closeMenusExcept(type);
            menu.style.display = isOpen ? 'none' : 'block';
        }

        function selectOption(type, value) {
            if (type === 'subject') {
                selectedSubject = value;
                selectedTopic = null;
                document.querySelector('#subjectDropdown .dropdown-toggle').textContent = value;

                // Populate topics
                const topicDropdown = document.getElementById('topicDropdown');
                const topicMenu = document.getElementById('topicMenu');
                topicMenu.innerHTML = '';
                if (topicMap[value]) {
                    topicMap[value].forEach(topic => {
                        const div = document.createElement('div');
                        div.textContent = topic;
                        div.onclick = () => selectOption('topic', topic);
                        topicMenu.appendChild(div);
                    });
                    topicDropdown.classList.remove('disabled');
                    document.querySelector('#topicDropdown .dropdown-toggle').textContent = 'Select Topic';
                } else {
                    topicDropdown.classList.add('disabled');
                    document.querySelector('#topicDropdown .dropdown-toggle').textContent = 'Select Topic';
                }
                document.getElementById('showButton').disabled = false; // Enable for subject only
                // Hide past performance section on subject change
                document.getElementById('pastPerformanceSection').style.display = 'none';
            } else if (type === 'topic') {
                selectedTopic = value;
                document.querySelector('#topicDropdown .dropdown-toggle').textContent = value;
                document.getElementById('showButton').disabled = false;
            }
            closeMenusExcept();
        }

        function getLabelText() {
            if (selectedSubject && selectedTopic) {
                return `Showing performance for <b>${selectedSubject} - ${selectedTopic}</b>`;
            } else if (selectedSubject) {
                return `Showing performance for <b>${selectedSubject}</b>`;
            } else {
                return "Showing overall performance";
            }
        }

        // Loader while authenticating/fetching
        document.getElementById('performanceCircles').innerHTML = `<div class="loader"></div>`;

        // FIREBASE PERFORMANCE FETCH AND AGGREGATION
        async function fetchAndShowPerformance(uid) {
            // Loader
            document.getElementById('performanceLabel').innerHTML = "Loading your performance...";
            document.getElementById('performanceCircles').innerHTML = `<div class="loader"></div>`;

            // Fetch all results for this user (latest first)
            let resultsSnap;
            try {
                resultsSnap = await db.collection("users").doc(uid).collection("results").orderBy("timestamp", "desc").get();
            } catch (e) {
                document.getElementById('performanceLabel').innerHTML = "Failed to fetch performance. Please try again.";
                document.getElementById('performanceCircles').innerHTML = "";
                return;
            }
            const results = resultsSnap.docs.map(doc => doc.data());

            // Aggregate overall stats
            const overall = {
                totalTestAttempts: results.length,
                totalQuestionAttempts: 0,
                totalCorrect: 0,
                totalWrong: 0,
                totalAvgResponseTime: 0,
                totalEfficiency: 0
            };
            // Subject/topic grouping
            const subjectStats = {};
            const topicStats = {};
            const topicHistory = {};

            results.forEach(res => {
                const topicKey = `${res.subject}_${res.topic}`;
                // Overall
                overall.totalQuestionAttempts += Number(res.totalAttempted || 0);
                overall.totalCorrect += Number(res.correct || 0);
                overall.totalWrong += Number(res.wrong || 0);
                overall.totalAvgResponseTime += Number(res.avgResponseTime || 0);

                // Subject
                if (!subjectStats[res.subject]) {
                    subjectStats[res.subject] = { totalTestAttempts: 0, totalQuestionAttempts: 0, totalCorrect: 0, totalWrong: 0, totalAvgResponseTime: 0 };
                }
                subjectStats[res.subject].totalTestAttempts++;
                subjectStats[res.subject].totalQuestionAttempts += Number(res.totalAttempted || 0);
                subjectStats[res.subject].totalCorrect += Number(res.correct || 0);
                subjectStats[res.subject].totalWrong += Number(res.wrong || 0);
                subjectStats[res.subject].totalAvgResponseTime += Number(res.avgResponseTime || 0);

                // Topic
                if (!topicStats[topicKey]) {
                    topicStats[topicKey] = { totalTestAttempts: 0, totalQuestionAttempts: 0, totalCorrect: 0, totalWrong: 0, totalAvgResponseTime: 0 };
                    topicHistory[topicKey] = [];
                }
                topicStats[topicKey].totalTestAttempts++;
                topicStats[topicKey].totalQuestionAttempts += Number(res.totalAttempted || 0);
                topicStats[topicKey].totalCorrect += Number(res.correct || 0);
                topicStats[topicKey].totalWrong += Number(res.wrong || 0);
                topicStats[topicKey].totalAvgResponseTime += Number(res.avgResponseTime || 0);

                // Past history for topic
                topicHistory[topicKey].push({
                    date: res.date,
                    time: res.time,
                    totalQuestionAttempts: res.totalAttempted,
                    right: res.correct,
                    wrong: res.wrong,
                    avgResponseTime: (typeof res.avgResponseTime === 'number' ? res.avgResponseTime.toFixed(2) : res.avgResponseTime) + "s",
                    fastestResponse: (typeof res.fastestResponse === 'number' ? res.fastestResponse.toFixed(2) : res.fastestResponse) + "s",
                    efficiency: (typeof res.efficiency === 'number' ? res.efficiency.toFixed(2) : res.efficiency) + "%"
                });
            });

            // Calculate efficiency and avg times
            overall.efficiency = overall.totalQuestionAttempts
                ? Math.round((overall.totalCorrect / overall.totalQuestionAttempts) * 100) + "%"
                : "0%";
            overall.avgResponseTime = overall.totalTestAttempts
                ? (overall.totalAvgResponseTime / overall.totalTestAttempts).toFixed(2) + "s"
                : "--";

            Object.entries(subjectStats).forEach(([key, stat]) => {
                stat.efficiency = stat.totalQuestionAttempts
                    ? Math.round((stat.totalCorrect / stat.totalQuestionAttempts) * 100) + "%"
                    : "0%";
                stat.avgResponseTime = stat.totalTestAttempts
                    ? (stat.totalAvgResponseTime / stat.totalTestAttempts).toFixed(2) + "s"
                    : "--";
            });
            Object.entries(topicStats).forEach(([key, stat]) => {
                stat.efficiency = stat.totalQuestionAttempts
                    ? Math.round((stat.totalCorrect / stat.totalQuestionAttempts) * 100) + "%"
                    : "0%";
                stat.avgResponseTime = stat.totalTestAttempts
                    ? (stat.totalAvgResponseTime / stat.totalTestAttempts).toFixed(2) + "s"
                    : "--";
            });

            // Now, replace your demo data with these live objects
            window.performanceData = {
                overall,
                ...subjectStats,
                ...topicStats
            };
            window.pastPerformanceHistory = topicHistory;

            // Initial render
            document.getElementById('performanceLabel').innerHTML = getLabelText();
            updateCircles('overall');
        }

        // UI rendering functions (same as before)
        function updateCircles(dataKey) {
            const perfSection = document.getElementById('performanceSection');
            const labelDiv = document.getElementById('performanceLabel');
            labelDiv.innerHTML = getLabelText();
            perfSection.classList.remove('loading');
            document.getElementById('performanceCircles').innerHTML = `<div class="loader"></div>`;

            setTimeout(() => {
                const data = (window.performanceData && window.performanceData[dataKey]) ? window.performanceData[dataKey] : (window.performanceData ? window.performanceData['overall'] : null);
                if (!data) {
                    document.getElementById('performanceCircles').innerHTML = `<div style="padding:20px;text-align:center;color:#888;">No data available.</div>`;
                    return;
                }
                document.getElementById('performanceCircles').innerHTML = `
                    <div class="circle-stat">
                        <div class="circle-value" id="totalTestAttempts">${data.totalTestAttempts || 0}</div>
                        <div class="circle-label">Total Test Attempts</div>
                    </div>
                    <div class="circle-stat">
                        <div class="circle-value" id="totalQuestionAttempts">${data.totalQuestionAttempts || 0}</div>
                        <div class="circle-label">Total Question Attempts</div>
                    </div>
                    <div class="circle-stat">
                        <div class="circle-value" id="totalCorrect">${data.totalCorrect || 0}</div>
                        <div class="circle-label">Total Correct</div>
                    </div>
                    <div class="circle-stat">
                        <div class="circle-value" id="totalWrong">${data.totalWrong || 0}</div>
                        <div class="circle-label">Total Wrong</div>
                    </div>
                    <div class="circle-stat">
                        <div class="circle-value" id="efficiency">${data.efficiency || "0%"}</div>
                        <div class="circle-label">Efficiency</div>
                    </div>
                    <div class="circle-stat">
                        <div class="circle-value" id="avgResponseTime">${data.avgResponseTime || "--"}</div>
                        <div class="circle-label">Avg. Response Time</div>
                    </div>
                `;
            }, 400); // Simulate fetch delay
        }

        function showPerformance() {
            const pastSection = document.getElementById('pastPerformanceSection');
            if (selectedSubject && selectedTopic) {
                // Show topic-specific data if exists, else fallback to subject
                const topicKey = `${selectedSubject}_${selectedTopic}`;
                updateCircles(window.performanceData && window.performanceData[topicKey] ? topicKey : selectedSubject);
                // Show past performance for this topic
                setTimeout(() => {
                    renderPastPerformanceSection(topicKey);
                }, 500);
            } else {
                // Hide past performance if not topic selected
                pastSection.style.display = 'none';
                if (selectedSubject) {
                    updateCircles(selectedSubject);
                } else {
                    updateCircles('overall');
                }
            }
        }

        function renderPastPerformanceSection(topicKey) {
            const pastSection = document.getElementById('pastPerformanceSection');
            const history = (window.pastPerformanceHistory && window.pastPerformanceHistory[topicKey]) ? window.pastPerformanceHistory[topicKey] : [];

            if (!history || !history.length) {
                pastSection.innerHTML = '';
                pastSection.style.display = 'none';
                return;
            }
            let tableRows = '';
            for (const perf of history) {
                tableRows += `
                    <tr>
                        <td>${perf.date}</td>
                        <td>${perf.time}</td>
                        <td>${perf.totalQuestionAttempts}</td>
                        <td>${perf.right}</td>
                        <td>${perf.wrong}</td>
                        <td>${perf.avgResponseTime}</td>
                        <td>${perf.fastestResponse}</td>
                        <td>${perf.efficiency}</td>
                    </tr>
                `;
            }
            pastSection.innerHTML = `
                <div class="past-performance-section">
                    <div class="past-performance-title">Past Performance</div>
                    <div class="past-table-wrap">
                        <table class="past-performance-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Total Ques Attempts</th>
                                    <th>Right</th>
                                    <th>Wrong</th>
                                    <th>Avg Response Time</th>
                                    <th>Fastest Response</th>
                                    <th>Efficiency</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            pastSection.style.display = '';
        }

        // Home button logic
        function goHome() {
            window.location.href = "index.html";
        }

        // Reload button logic
        function reloadPage() {
            window.location.reload();
        }

        // Initial loader and Firebase Auth check
        document.getElementById('performanceLabel').innerHTML = "Loading your performance...";

        // Wait for Firebase Auth, then fetch and show stats
        auth.onAuthStateChanged(user => {
            if (user) {
                fetchAndShowPerformance(user.uid);
            } else {
                document.body.innerHTML = "<h2 style='margin:40px;text-align:center;'>Please sign in to view your performance.</h2>";
            }
        });
    </script>
</body>
</html>